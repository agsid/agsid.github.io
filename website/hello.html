<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/x-icon" href="./images/logo.png">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        $(function () {
            // These lines are for loading external header/footer,
            // which are not provided in this single HTML file.
            // Keeping them commented out or removing them as they might cause errors
            // if header.html/footer.html are not present.
            $("#includedContent").load("header.html");
            // $("#Content").load("footer.html");
        });
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allied Work</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
        /* New VS Code inspired color variables */
        :root {
            /* VS Code-like Light Theme */
            --bg-primary: #FFFFFF; /* Editor background */
            --bg-secondary: #F3F3F3; /* Sidebar/UI background */
            --bg-tertiary: #E7E7E7; /* Bottom panel/console background */
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-heading-main: #007ACC; /* VS Code blue for primary headings */
            --text-heading-sub: #005A9C;
            --border-color: #CCCCCC;
            --tab-bg-active: #FFFFFF;
            --tab-bg-inactive: #E7E7E7;
            --tab-border-active: #007ACC;
            --tab-border-inactive: transparent;
            --console-bg: #EFEFEF;
            --console-text: #333333;
            --status-bar-bg: #007ACC;
            --status-bar-text: #FFFFFF;
            /* Syntax highlighting for light mode */
            --comment-color: #008000;
            --keyword-color: #0000FF;
            --string-color: #A31515;
            --function-color: #795E26;
            --resizer-bg: #E0E0E0;
            --resizer-hover-bg: #007ACC;
        }

        .dark-mode {
            /* VS Code-like Dark Theme */
            --bg-primary: #1E1E1E;
            --bg-secondary: #252526;
            --bg-tertiary: #333333;
            --text-primary: #D4D4D4;
            --text-secondary: #9B9B9B;
            --text-heading-main: #569CD6;
            --text-heading-sub: #4EC9B0;
            --border-color: #3C3C3C;
            --tab-bg-active: #1E1E1E;
            --tab-bg-inactive: #2D2D2D;
            --tab-border-active: #569CD6;
            --tab-border-inactive: transparent;
            --console-bg: #000000;
            --console-text: #D4D4D4;
            --status-bar-bg: #007ACC;
            --status-bar-text: #FFFFFF;
            /* Syntax highlighting for dark mode */
            --comment-color: #6A9955;
            --keyword-color: #569CD6;
            --string-color: #CE9178;
            --function-color: #DCDCAA;
            --resizer-bg: #4C4C4C;
            --resizer-hover-bg: #569CD6;
        }

        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 0;
            background-color: var(--bg-secondary);
            transition: background-color 0.4s ease, color 0.4s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            color: var(--text-primary);
        }

        #app-container {
            display: grid;
            grid-template-columns: 50px 1fr;
            grid-template-rows: 1fr auto;
            width: 100%;
            height: 100vh;
            background-color: var(--bg-primary);
            overflow: hidden;
        }

        /* Left sidebar for classic VS Code look */
        #left-sidebar {
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            grid-row: 1 / 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 1rem;
            color: var(--text-secondary);
            gap: 1.5rem;
        }

        #left-sidebar ion-icon {
            font-size: 1.8rem;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        #left-sidebar a {
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }

        #left-sidebar ion-icon.active, #left-sidebar ion-icon:hover, #left-sidebar a:hover {
            color: var(--text-primary);
        }
        
        #main-content-area {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr auto;
            height: 100%;
        }

        #top-bar {
            grid-row: 1;
            display: flex;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding-left: 1rem;
            align-items: center;
        }
        
        #editor-and-simulation {
            display: flex;
            grid-row: 2;
            width: 100%;
            height: 100%;
            position: relative;
        }

        #editor-panel, #simulation-panel {
            flex: 1;
            height: 100%;
            padding: 1rem;
            background-color: var(--bg-primary);
            display: flex;
            flex-direction: column;
            min-width: 250px; /* Minimum width for panels */
        }

        #editor-panel {
            border-right: 1px solid var(--border-color);
        }

        #simulation-panel {
            padding: 1rem;
            background-color: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        #editor-resizer {
            width: 5px;
            background-color: var(--resizer-bg);
            cursor: col-resize;
            transition: background-color 0.2s ease;
        }
        
        #editor-resizer:hover {
            background-color: var(--resizer-hover-bg);
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background-color: var(--tab-bg-inactive);
            color: var(--text-secondary);
            border-bottom: 2px solid var(--tab-border-inactive);
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
        }

        .tab-button:hover {
            color: var(--text-primary);
            background-color: var(--tab-bg-active);
        }

        .tab-button.active {
            color: var(--text-primary);
            background-color: var(--tab-bg-active);
            border-bottom: 2px solid var(--tab-border-active);
        }
        
        .tab-content {
            display: none;
            flex-grow: 1;
            width: 100%;
            background-color: var(--bg-primary);
            padding: 1rem;
            box-sizing: border-box;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        canvas {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            display: block;
            width: 100%;
            height: auto;
            max-width: 960px;
            max-height: 480px;
            object-fit: contain;
        }
        
        .code-editor-container {
            display: flex;
            flex-grow: 1;
            position: relative;
        }
        
        #line-numbers {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            padding: 1rem 0.5rem;
            width: 40px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            text-align: right;
            color: var(--text-secondary);
            overflow-y: hidden;
            font-family: 'Fira Code', monospace;
            font-size: 1rem;
            line-height: 1.5;
            pointer-events: none;
            z-index: 3;
            box-sizing: border-box;
        }
        
        #code-editor {
            flex-grow: 1;
            padding: 1rem;
            padding-left: 50px; /* Make space for line numbers */
            font-family: 'Fira Code', monospace;
            font-size: 1rem;
            line-height: 1.5;
            background-color: transparent;
            color: transparent;
            caret-color: var(--text-primary);
            resize: none;
            border: none;
            outline: none;
            box-shadow: none;
            box-sizing: border-box;
            position: relative;
            z-index: 2;
            overflow-y: auto;
            overflow-x: auto;
            white-space: pre;
            word-wrap: normal;
        }

        #highlight-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1rem;
            padding-left: 50px; /* Make space for line numbers */
            font-family: 'Fira Code', monospace;
            font-size: 1rem;
            line-height: 1.5;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow-y: hidden;
            overflow-x: auto;
            white-space: pre;
            word-wrap: normal;
            z-index: 1;
            box-sizing: border-box;
            pointer-events: none;
        }
        
        /* New styles for full-screen Python code view */
        .python-display-container.active,
        .commands-display-container.active {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            background-color: var(--bg-tertiary); /* Same as bottom panel */
            overflow: auto;
        }

        #python-code-display,
        #commands-display-container {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: 'Fira Code', monospace;
            font-size: 1rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
            height: 100%;
            width: 100%;
            overflow: auto;
            padding: 1rem;
            box-sizing: border-box;
        }
        
        /* Syntax Highlighting Styles */
        .comment-highlight { color: var(--comment-color); }
        .string-highlight { color: var(--string-color); }
        .function-highlight { color: var(--function-color); }
        
        /* Bottom panel for console */
        #bottom-panel {
            grid-row: 3;
            background-color: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            resize: vertical;
            overflow: hidden;
            min-height: 150px;
            max-height: 50vh;
        }
        
        #bottom-panel-tabs {
            display: flex;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 1rem;
        }
        
        #bottom-panel-tabs button {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        #bottom-panel-tabs button:hover {
            color: var(--text-primary);
        }

        #bottom-panel-tabs button.active {
            color: var(--text-primary);
            border-bottom: 2px solid var(--tab-border-active);
        }
        
        #console-output {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--console-bg);
            color: var(--console-text);
            font-family: 'Fira Code', monospace;
            font-size: 0.95rem;
            padding: 0.5rem 1rem;
        }
        
        .console-line {
            padding: 0.2em 0;
        }
        
        .console-timestamp {
            color: var(--text-secondary);
            margin-right: 0.5em;
        }

        #status-bar {
            grid-column: 1 / 3;
            background-color: var(--status-bar-bg);
            color: var(--status-bar-text);
            padding: 0.3rem 1rem;
            font-size: 0.8rem;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 1rem;
        }

        /* General UI components */
        .button {
            padding: 0.6rem 1.2rem;
            border-radius: 0.3rem;
            font-weight: 500;
            cursor: pointer;
            background-color: #007ACC;
            color: #FFFFFF;
            border: none;
            font-family: 'Inter', sans-serif;
            transition: background-color 0.2s ease;
        }

        .button:hover {
            background-color: #0060A0;
        }

        #run-button { background-color: #4CAF50; }
        #run-button:hover { background-color: #45a049; }

        /* Other styles remain mostly the same, but with new color variables */
        h1, h2, h3, p, ul, li { color: var(--text-primary); }
        code {
            font-family: 'Fira Code', monospace;
            color: var(--text-primary);
            background-color: var(--bg-tertiary);
            padding: 0.25em 0.5em;
        }

        #settings-dropdown, .message-box {
            display: none; /* Hide these for the VS Code theme */
        }
    </style>
</head>
<body class="dark-mode">
    <div id="app-container">
        <!-- VS Code-like Sidebar -->
        <div id="left-sidebar">
            <ion-icon name="code-slash-outline" class="active"></ion-icon>
            <a href="https://agsid.github.io/doc.html"><ion-icon name="help-circle-outline"></ion-icon></a>
            <ion-icon name="cog-outline" id="theme-mode-toggle"></ion-icon>
        </div>
        
        <div id="main-content-area">
            <!-- Top Tab Bar -->
            <div id="top-bar">
                <button class="tab-button active" data-tab-target="tab-content-editor">Code Editor</button>
                <button class="tab-button" data-tab-target="tab-content-commands">
                    Available Commands
                    <span id="close-commands-tab" class="hidden text-red-500 hover:text-red-300 ml-2" style="font-size: 1.2em;">
                        <ion-icon name="close-circle-outline"></ion-icon>
                    </span>
                </button>
                <button class="tab-button" data-tab-target="tab-content-python">
                    Generated Python
                    <span id="close-python-tab" class="hidden text-red-500 hover:text-red-300 ml-2" style="font-size: 1.2em;">
                        <ion-icon name="close-circle-outline"></ion-icon>
                    </span>
                </button>
            </div>

            <!-- Main Content: Editor & Simulation -->
            <div id="editor-and-simulation">
                <div id="editor-panel" class="tab-content active" data-tab-id="tab-content-editor">
                    <div class="code-editor-container">
                        <div id="line-numbers"></div>
                        <div id="highlight-overlay"></div>
                        <textarea id="code-editor" spellcheck="false" placeholder="Type your commands here...">
// Welcome to Allied Algorithms FLL Bot Programmer!
// Use the commands on the 'Available Commands' tab to control your robot.
print("Initializing robot on the field...")
// Robot starts at the center of the bottom edge of the field, facing up.
// Let's program it to navigate to a specific mission area.
drive(30) // Drive 30 inches forward (upwards)
turn(90) // Turn 90 degrees clockwise (robot now faces right)
arm("up") // Move the arm up
wait(1) // Wait for 1 second for the arm to complete action
print("Robot completed mission segment!")
</textarea>
                    </div>
                </div>
                
                <div id="editor-resizer"></div>

                <div id="simulation-panel">
                    <div class="flex flex-row justify-center space-x-4 mb-6">
                        <button id="run-button" class="button">
                            <svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.132V9.868c0-.836.828-1.309 1.402-.868l3.197 2.132a1 1 0 010 1.736z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Run Code
                        </button>
                        <button id="reset-button" class="button">
                            <ion-icon name="refresh-outline"></ion-icon>
                            Clear Code
                        </button>
                    </div>
                    <canvas id="robot-canvas"></canvas>
                </div>

                <div id="tab-content-commands" class="tab-content commands-display-container">
                    <div id="commands-display-container"></div>
                </div>
                
                <div id="tab-content-python" class="tab-content python-display-container">
                    <pre id="python-code-display"></pre>
                </div>
            </div>

            <!-- Bottom Panel: Console Output -->
            <div id="bottom-panel">
                <div id="bottom-panel-tabs">
                    <button id="console-tab-button" class="active">Console</button>
                </div>
                <div id="console-output"></div>
            </div>
        </div>

        <!-- Status Bar -->
        <div id="status-bar">
            <span>FLL Bot Programmer</span>
            <span>UTF-8</span>
            <span>LF</span>
            <span>Line 1, Col 1</span>
        </div>
    </div>
    
    <script>
        const appContainer = document.getElementById('app-container');
        const themeToggle = document.getElementById('theme-mode-toggle');
        const runButton = document.getElementById('run-button');
        const resetButton = document.getElementById('reset-button');
        const codeEditor = document.getElementById('code-editor');
        const highlightOverlay = document.getElementById('highlight-overlay');
        const pythonCodeDisplay = document.getElementById('python-code-display');
        const commandsDisplayContainer = document.getElementById('commands-display-container');
        const consoleOutput = document.getElementById('console-output');
        const messageBox = document.getElementById('message-box');
        const uploadButton = document.getElementById('upload-button');
        const fileUpload = document.getElementById('file-upload');
        const startLeftButton = document.getElementById('start-left-button');
        const startRightButton = document.getElementById('start-right-button');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const closePythonTabButton = document.getElementById('close-python-tab');
        const closeCommandsTabButton = document.getElementById('close-commands-tab');
        const editorResizer = document.getElementById('editor-resizer');
        const editorPanel = document.getElementById('editor-panel');
        const simulationPanel = document.getElementById('simulation-panel');
        const consoleLog = [];
        const canvas = document.getElementById('robot-canvas');
        const ctx = canvas.getContext('2d');
        const fieldWidth = 960; // FLL field is 96 inches, we scale to 960px
        const fieldHeight = 480; // FLL field is 48 inches, we scale to 480px
        const robotSize = 24; // Increased from 18 to 24
        let robotX = fieldWidth / 2;
        let robotY = fieldHeight - (robotSize / 2);
        let robotAngle = 0; // 0 degrees is facing up
        let simulationRunning = false;
        let simulationQueue = [];
        let messageDisplay = '';
        const commandMapping = {
            'drive': {
                regex: /drive\(([-+]?\d*\.?\d+)\)/,
                python: (distance) => `await drive(${distance})`,
                handler: (distance) => {
                    return new Promise(resolve => {
                        const distanceInPx = distance * 10;
                        const initialX = robotX;
                        const initialY = robotY;
                        const duration = Math.abs(distanceInPx) * 10;
                        const startTime = performance.now();
                        const animate = (time) => {
                            const elapsed = time - startTime;
                            const progress = Math.min(elapsed / duration, 1);
                            const newX = initialX + distanceInPx * Math.sin(robotAngle * Math.PI / 180) * progress;
                            const newY = initialY - distanceInPx * Math.cos(robotAngle * Math.PI / 180) * progress;
                            robotX = newX;
                            robotY = newY;
                            drawRobot();
                            if (progress < 1) {
                                requestAnimationFrame(animate);
                            } else {
                                resolve();
                            }
                        };
                        requestAnimationFrame(animate);
                    });
                }
            },
            'turn': {
                regex: /turn\(([-+]?\d*\.?\d+)\)/,
                python: (degrees) => `await turn(${degrees})`,
                handler: (degrees) => {
                    return new Promise(resolve => {
                        const initialAngle = robotAngle;
                        const duration = Math.abs(degrees) * 10;
                        const startTime = performance.now();
                        const animate = (time) => {
                            const elapsed = time - startTime;
                            const progress = Math.min(elapsed / duration, 1);
                            robotAngle = initialAngle + degrees * progress;
                            drawRobot();
                            if (progress < 1) {
                                requestAnimationFrame(animate);
                            } else {
                                resolve();
                            }
                        };
                        requestAnimationFrame(animate);
                    });
                }
            },
            'print': {
                regex: /print\(\"(.+?)\"\)/,
                python: (message) => `print("${message}")`,
                handler: (message) => {
                    return new Promise(resolve => {
                        logToConsole(message, 'info');
                        resolve();
                    });
                }
            },
            'wait': {
                regex: /wait\(([-+]?\d*\.?\d+)\)/,
                python: (seconds) => `wait(${parseFloat(seconds) * 1000})`,
                handler: (seconds) => {
                    return new Promise(resolve => {
                        const milliseconds = parseFloat(seconds) * 1000;
                        logToConsole(`Waiting for ${seconds}s...`, 'info');
                        setTimeout(resolve, milliseconds);
                    });
                }
            },
            'arm': {
                regex: /arm\(\"(.+?)\"\)/,
                python: (action) => {
                    if (action === "up") {
                        return `speed_motor(50) # Assuming a speed of 50 for the arm motor
    await turn_motor(port.A, 90) # Assuming 'up' is a 90-degree turn on port A`;
                    } else if (action === "down") {
                        return `speed_motor(50)
    await turn_motor(port.A, -90) # Assuming 'down' is a -90-degree turn on port A`;
                    } else if (action === "reset") {
                        return `speed_motor(50)
    await turn_motor(port.A, 0) # Assuming 'reset' is a 0-degree turn on port A`;
                    }
                    return `# WARNING: Invalid arm action: ${action}`;
                },
                handler: (action) => {
                    return new Promise(resolve => {
                        logToConsole(`Arm action: ${action}`, 'info');
                        setTimeout(resolve, 500); // Simulate arm movement time
                    });
                }
            }
        };
        function setupCanvas() {
            canvas.width = fieldWidth;
            canvas.height = fieldHeight;
            drawRobot();
        }
        function drawRobot() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Draw field
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary');
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border-color');
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            // Draw a simple FLL home base area
            ctx.fillStyle = 'rgba(128, 128, 128, 0.2)';
            ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
            // Save the context state before rotating
            ctx.save();
            // Translate to the robot's position and rotate the context
            ctx.translate(robotX, robotY);
            ctx.rotate(robotAngle * Math.PI / 180);
            // Draw the robot
            ctx.fillStyle = '#1A7A72'; // Dark teal
            ctx.fillRect(-robotSize / 2, -robotSize / 2, robotSize, robotSize);
            // Draw the direction indicator (a triangle)
            ctx.fillStyle = '#0F2D37'; // Even darker color
            ctx.beginPath();
            ctx.moveTo(0, -robotSize / 2);
            ctx.lineTo(-robotSize / 3, 0);
            ctx.lineTo(robotSize / 3, 0);
            ctx.closePath();
            ctx.fill();
            // Restore the context state to prevent further drawing from being rotated
            ctx.restore();
            // Draw message display
            if (messageDisplay) {
                ctx.fillStyle = '#ffffff';
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 1;
                ctx.font = '24px "Montserrat", sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const textWidth = ctx.measureText(messageDisplay).width;
                const boxWidth = textWidth + 30;
                const boxHeight = 50;
                const boxX = (canvas.width - boxWidth) / 2;
                const boxY = (canvas.height - boxHeight) / 2;
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(boxX, boxY, boxWidth, boxHeight);
                ctx.fillStyle = '#ffffff';
                ctx.fillText(messageDisplay, canvas.width / 2, canvas.height / 2);
            }
        }
        function logToConsole(message, type) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            consoleLog.push(logEntry);
            updateConsoleOutput();
        }
        function updateConsoleOutput() {
            consoleOutput.innerHTML = '';
            consoleLog.forEach(logEntry => {
                const line = document.createElement('div');
                line.classList.add('console-line');
                const timestampSpan = document.createElement('span');
                timestampSpan.classList.add('console-timestamp');
                timestampSpan.textContent = `[${logEntry.timestamp}]`;
                line.appendChild(timestampSpan);
                line.appendChild(document.createTextNode(logEntry.message));
                consoleOutput.appendChild(line);
            });
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        function showMessage(message, isError = false) {
            // This function is now effectively disabled by CSS, but keeping it for potential future use
        }
        function updateSyntaxHighlighting() {
            const text = codeEditor.value;
            let highlightedText = escapeHtml(text);
            const lineNumbers = document.getElementById('line-numbers');
            if (lineNumbers) {
                const lines = text.split('\n').length;
                lineNumbers.innerHTML = Array.from({ length: lines }, (_, i) => `<div>${i + 1}</div>`).join('');
            }
            // Highlighting for comments and strings
            highlightedText = highlightedText.replace(/(\/\/.*)/g, '<span class="comment-highlight">$1</span>');
            highlightedText = highlightedText.replace(/(\".*?\")/g, '<span class="string-highlight">$1</span>');
            
            // Highlight specific commands that are "functions"
            const functionCommands = ['arm'];
            functionCommands.forEach(cmd => {
                const regex = new RegExp(`\\b(${cmd})\\(`, 'g');
                highlightedText = highlightedText.replace(regex, `<span class="function-highlight">$1</span>(`);
            });

            highlightOverlay.innerHTML = highlightedText;
        }
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        function startSimulation() {
            if (simulationRunning) {
                return;
            }
            const commands = codeEditor.value.trim().split('\n').filter(line => line.trim() !== '' && !line.trim().startsWith('//'));
            
            // Validate all commands before starting
            for (const commandLine of commands) {
                let matched = false;
                for (const command of Object.values(commandMapping)) {
                    if (commandLine.match(command.regex)) {
                        matched = true;
                        break;
                    }
                }
                if (!matched) {
                    logToConsole(`ERROR: Unknown command or syntax error on line: "${commandLine}". Simulation aborted.`, 'error');
                    return; // Abort the entire simulation
                }
            }
            
            simulationRunning = true;
            simulationQueue = [...commands];
            logToConsole('Simulation started.', 'info');
            runNextCommand();
        }
        async function runNextCommand() {
            if (simulationQueue.length === 0 || !simulationRunning) {
                simulationRunning = false;
                logToConsole('Simulation finished.', 'info');
                return;
            }
            const commandLine = simulationQueue.shift().trim();
            logToConsole(`> Running command: ${commandLine}`, 'info');
            let matched = false;
            for (const command of Object.values(commandMapping)) {
                const match = commandLine.match(command.regex);
                if (match) {
                    matched = true;
                    try {
                        await command.handler(...match.slice(1));
                    } catch (e) {
                        logToConsole(`Error executing command: ${commandLine}`, 'error');
                        console.error(e);
                    }
                    break;
                }
            }
            if (!matched) {
                logToConsole(`Unknown command: ${commandLine}`, 'error');
            }
            runNextCommand();
        }
        function generatePythonCode() {
            const lines = codeEditor.value.trim().split('\n');
            let generatedCode = `import runloop,math,motor_pair,motor,time
from hub import port
# r is the radius of the wheel. This is used to find the circumference of the wheel
r = 22 # Assuming a standard LEGO wheel with a radius of 22mm
# This is the angle changed when the wheels run for 1 rotation in opposite directions.
# This is used in the turning function to convert a desired turn angle into motor degrees.
total=100

def speed(x):
    global velocity
    velocity = x*110

async def drive(desired):
    circumference=2*r*math.pi
    rotations=desired/circumference
    degrees=int(rotations*360)
    await motor_pair.move_for_degrees(motor_pair.PAIR_1, degrees, 0, velocity=velocity)

async def turn(desired):
    distance=int((desired/total)*360)
    await motor_pair.move_for_degrees(motor_pair.PAIR_1, distance, 100)

def speed_motor(x):
    global velocity_motor
    velocity_motor = x*110

async def turn_motor(port,desired):
    angle = desired/2
    motor.run_for_degrees(port.port, angle, velocity_motor)

def wait(mili):
    time.sleep_ms(mili)

async def main():
    motor_pair.pair(motor_pair.PAIR_1, port.C, port.D)
    
    # User's code starts here
    # We will set a default drive speed.
    speed(50)
    
`;
            
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('//') || trimmedLine === '') {
                    generatedCode += `\n    ${line}`;
                    return;
                }
                let translated = false;
                for (const command of Object.values(commandMapping)) {
                    const match = trimmedLine.match(command.regex);
                    if (match) {
                        const pythonCode = command.python(...match.slice(1));
                        generatedCode += `\n    ${pythonCode.split('\n').join('\n    ')}`;
                        translated = true;
                        break;
                    }
                }
                if (!translated) {
                    generatedCode += `\n    # WARNING: Could not translate this line: ${trimmedLine}`;
                }
            });

            generatedCode += `\n    \nrunloop.run(main())`;
            
            pythonCodeDisplay.innerText = generatedCode;
        }

        // --- Local Storage Functions ---
        const LOCAL_STORAGE_KEY = 'fll_bot_code';

        function saveCodeToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_KEY, codeEditor.value);
            logToConsole('Code saved to local storage.', 'info');
        }

        function loadCodeFromLocalStorage() {
            const savedCode = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedCode) {
                codeEditor.value = savedCode;
                updateSyntaxHighlighting();
                logToConsole('Code loaded from local storage.', 'info');
            } else {
                logToConsole('No saved code found in local storage.', 'info');
            }
        }
        
        function clearCodeFromLocalStorage() {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            codeEditor.value = "";
            updateSyntaxHighlighting();
            logToConsole('Local storage cleared.', 'info');
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
        // Event Listeners
        runButton.addEventListener('click', () => {
            generatePythonCode();
            startSimulation();
        });
        resetButton.addEventListener('click', () => {
            simulationRunning = false;
            simulationQueue = [];
            robotX = fieldWidth / 2;
            robotY = fieldHeight - (robotSize / 2);
            robotAngle = 0;
            consoleLog.length = 0;
            updateConsoleOutput();
            drawRobot();
            clearCodeFromLocalStorage();
            logToConsole('Simulation reset.', 'info');
        });

        // Auto-save on input with debounce
        codeEditor.addEventListener('input', () => {
            updateSyntaxHighlighting();
            debounce(saveCodeToLocalStorage, 500)();
        });
        
        themeToggle.addEventListener('click', () => {
            if (document.body.classList.contains('dark-mode')) {
                document.body.classList.remove('dark-mode');
            } else {
                document.body.classList.add('dark-mode');
            }
        });

        // Resizer Logic
        editorResizer.addEventListener('mousedown', (e) => {
            let initialX = e.clientX;
            let initialEditorWidth = editorPanel.offsetWidth;

            const onMouseMove = (moveEvent) => {
                const dx = moveEvent.clientX - initialX;
                let newWidth = initialEditorWidth + dx;
                
                // Clamp the new width to prevent panels from becoming too small
                if (newWidth < 250) { newWidth = 250; }
                if (newWidth > editorPanel.parentElement.offsetWidth - 250) {
                    newWidth = editorPanel.parentElement.offsetWidth - 250;
                }
                
                editorPanel.style.flex = `0 0 ${newWidth}px`;
                simulationPanel.style.flex = `1`; // Let simulation panel grow/shrink
            };

            const onMouseUp = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
        
        // Tab switching logic
        let commandsLoaded = false;
        tabButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const targetId = button.dataset.tabTarget;
                const targetContent = document.getElementById(targetId);

                tabButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.querySelector('span')?.classList.add('hidden');
                });
                tabContents.forEach(content => content.classList.remove('active'));
                
                button.classList.add('active');
                targetContent.classList.add('active');

                if (targetId === 'tab-content-python') {
                    generatePythonCode();
                    closePythonTabButton.classList.remove('hidden');
                } else if (targetId === 'tab-content-commands') {
                    closeCommandsTabButton.classList.remove('hidden');
                    if (!commandsLoaded) {
                        try {
                            const response = await fetch('commands.html');
                            if (response.ok) {
                                const html = await response.text();
                                commandsDisplayContainer.innerHTML = html;
                                commandsLoaded = true;
                            } else {
                                console.error('Failed to load commands.html');
                                commandsDisplayContainer.innerHTML = '<p>Failed to load commands. Please try again.</p>';
                            }
                        } catch (error) {
                            console.error('Network error loading commands.html:', error);
                            commandsDisplayContainer.innerHTML = '<p>Network error. Please check your connection.</p>';
                        }
                    }
                }
            });
        });

        closePythonTabButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const editorTabButton = document.querySelector('[data-tab-target="tab-content-editor"]');
            const editorTabContent = document.getElementById('tab-content-editor');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            editorTabButton.classList.add('active');
            editorTabContent.classList.add('active');
            closePythonTabButton.classList.add('hidden');
        });

        closeCommandsTabButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const editorTabButton = document.querySelector('[data-tab-target="tab-content-editor"]');
            const editorTabContent = document.getElementById('tab-content-editor');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            editorTabButton.classList.add('active');
            editorTabContent.classList.add('active');
            closeCommandsTabButton.classList.add('hidden');
        });

        // Initial setup
        window.onload = function() {
            setupCanvas();
            loadCodeFromLocalStorage();
            updateSyntaxHighlighting();
            document.getElementById('editor-panel').classList.add('active');
        };
    </script>
</body>
</html>
