<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlliedWork Editor</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Monaco Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
  html, body { height: 100%; margin: 0; font-family: 'Inter', sans-serif; }
  #editor { flex: 1; min-height: 200px; border-radius: 0.5rem; overflow: hidden; }
  #console { height: 140px; background: rgba(17, 24, 39, 0.75); backdrop-filter: blur(8px);
             color: #e2e8f0; overflow-y:auto; padding:0.75rem; font-family:monospace; resize:vertical;
             border-top: 1px solid rgba(255,255,255,0.05); border-radius: 0 0 0.75rem 0.75rem; }
  .iframe-container { flex:1; min-height:300px; }
  button { transition: all 0.3s ease; }
  .glass {
    background: rgba(30, 41, 59, 0.65);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.08);
  }
</style>
</head>

<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-gray-200 flex flex-col h-screen">

<!-- Top bar -->
<div class="glass flex items-center justify-between h-14 px-6 text-sm shadow-lg border-b border-gray-700">
  <div class="flex items-center space-x-3">
    <img src="../images/logo.png" alt="logo" class="w-7 h-7 rounded-full shadow-md">
    <span class="font-semibold text-blue-400 text-lg tracking-wide">AlliedWork</span>
  </div>
  <div class="text-gray-400 text-xs italic">FLL Code Editor</div>
</div>

<div class="flex flex-1 overflow-hidden">
  <!-- Sidebar -->
  <div class="glass flex flex-col w-20 border-r border-gray-700 py-3 items-center gap-4 shadow-lg">
    <button title="Home" class="hover:bg-gray-700/60 p-2 rounded-lg" onclick="location.href='index.html'">
      <span class="material-icons text-gray-300">home</span>
    </button>
    <button title="Toggle Theme" class="hover:bg-gray-700/60 p-2 rounded-lg" id="leftThemeToggle">
      <span class="material-icons text-gray-300">brightness_4</span>
    </button>
    <button title="Portfolio" class="hover:bg-gray-700/60 p-2 rounded-lg" onclick="window.open('https://agsid.github.io/portfolio/v2index.html','_blank')">
      <span class="material-icons text-gray-300">public</span>
    </button>
    <button title="Explorer" class="hover:bg-gray-700/60 p-2 rounded-lg" id="toggleExplorer">
      <span class="material-icons text-gray-300">menu</span>
    </button>
    <button title="Map" class="hover:bg-gray-700/60 p-2 rounded-lg" id="toggleMap">
      <span class="material-icons text-gray-300">map</span>
    </button>
  </div>

  <!-- Explorer Panel -->
  <div class="explorer glass w-64 border-r border-gray-700 p-4 text-sm overflow-y-auto transition-all duration-300">
    <h2 class="text-gray-400 uppercase text-xs mb-3 font-semibold tracking-widest">Explorer</h2>

    <div class="mb-4">
      <div class="text-gray-300 font-medium mb-1">User Files</div>
      <div id="file-user-main.py" class="cursor-pointer pl-4 py-1 hover:bg-gray-700/60 rounded transition" onclick="openFile('main.py')">main.py</div>
    </div>

    <div class="mb-4">
      <div class="text-gray-300 font-medium mb-1">Available Commands</div>
      <div id="file-avalComm.txt" class="cursor-pointer pl-4 py-1 hover:bg-gray-700/60 rounded transition" onclick="openFile('avalComm.txt')">avalComm.txt</div>
    </div>

    <div>
      <div class="text-gray-300 font-medium mb-1">Generated</div>
      <div id="file-generated-generated.py" class="cursor-pointer pl-4 py-1 hover:bg-gray-700/60 rounded transition" onclick="openFile('generated.py')">generated.py</div>
    </div>
  </div>

  <!-- Editor + Map + Console -->
  <div class="flex-1 flex flex-col overflow-hidden px-3 py-3 space-y-3">
    <div id="editor" class="rounded-lg shadow-inner border border-gray-800"></div>
    <iframe id="mapIframe" src="robot-map.html" class="rounded-lg shadow-lg flex-1 w-full border border-gray-800"></iframe>
    <div id="console" class="shadow-inner"></div>
  </div>
</div>

<script>
const defaultMain = `print('Hello from main.py')`;
const availableCommands = `
drive(inches)              → Move the robot forward a specific distance (in inches)
turn(degrees)              → Rotate the robot by a given angle (in degrees)
speed(%)                   → Set the overall robot speed (percentage)
speed_motor(%)             → Set speed of an individual motor (percentage)
turn_motor(port, degrees)  → Rotate a motor on the specified port by a number of degrees
wait(milliseconds)         → Pause execution for the given number of milliseconds
arm()                      → Activate the robot's arm mechanism
`;
const generatedTemplate = `
import runloop,math,motor_pair,motor,time
from hub import port
r = 22
total=100

def speed(x):
    global velocity
    velocity = x*110

async def drive(desired):
    circumference=2*r*math.pi
    rotations=desired/circumference
    degrees=int(rotations*360)
    await motor_pair.move_for_degrees(motor_pair.PAIR_1, degrees, 0, velocity=velocity)

async def turn(desired):
    distance=int((desired/total)*360)
    await motor_pair.move_for_degrees(motor_pair.PAIR_1, distance, 100)

def speed_motor(x):
    global velocity_motor
    velocity_motor = x*110

async def turn_motor(port,desired):
    angle = desired/2
    motor.run_for_degrees(port.port, angle, velocity_motor)

def wait(mili):
    time.sleep_ms(mili)

async def main():
    motor_pair.pair(motor_pair.PAIR_1, port.C, port.D)
    
    # User's code starts here
    speed(50)
`;

let currentFile = 'main.py';
let editor;
let files = { 'main.py': localStorage.getItem('main.py') || defaultMain, 'avalComm.txt': availableCommands };

function logConsole(msg){
  const consoleEl = document.getElementById('console');
  const p = document.createElement('div');
  p.textContent = msg;
  consoleEl.appendChild(p);
  consoleEl.scrollTop = consoleEl.scrollHeight;
}

function injectAsync(code){
  return code.replace(/\b(drive|turn|arm)\(/g, 'await $1(');
}

function getGeneratedContent(){
  return generatedTemplate + '\n' + injectAsync(files['main.py']) + '\nrunloop.run(main())';
}

function validateCommands(){
  const allowed = ['drive','turn','speed','speed_motor','turn_motor','wait','arm'];
  const lines = files['main.py'].split('\n');
  lines.forEach((line,i)=>{
    line = line.split('#')[0].trim();
    if(!line) return;
    let cmdMatch = line.match(/\b([a-zA-Z_][a-zA-Z0-9_]*)\s*\(/);
    if(cmdMatch && !allowed.includes(cmdMatch[1])){
      logConsole(`⚠️ Invalid command '${cmdMatch[1]}' at line ${i+1}`);
    }
  });
}

require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });
require(['vs/editor/editor.main'], function() {
  editor = monaco.editor.create(document.getElementById('editor'), {
    value: files['main.py'],
    language: 'python',
    theme: 'vs-dark',
    automaticLayout: true
  });
  editor.onDidChangeModelContent(() => {
    if(currentFile==='main.py'){
      files['main.py'] = editor.getValue();
      localStorage.setItem('main.py', files['main.py']);
      validateCommands();
      if(document.getElementById('mapIframe').contentWindow.parseMain)
        document.getElementById('mapIframe').contentWindow.parseMain();
    }
  });
});

function openFile(name){
  currentFile = name;
  const modelType = name.endsWith('.py') ? 'python' : 'plaintext';
  const content = name==='generated.py' ? getGeneratedContent() : files[name];
  const model = monaco.editor.createModel(content, modelType);
  editor.setModel(model);
  editor.updateOptions({readOnly: name !== 'main.py'});
}

// Sidebar toggles
const explorer = document.querySelector('.explorer');
const mapIframe = document.getElementById('mapIframe');

document.getElementById('toggleExplorer').addEventListener('click', ()=> explorer.classList.toggle('hidden'));
document.getElementById('toggleMap').addEventListener('click', ()=> mapIframe.classList.toggle('hidden'));

document.getElementById('leftThemeToggle').addEventListener('click', ()=>{
  const newTheme = editor._themeService._theme.themeName==='vs-dark'?'vs':'vs-dark';
  monaco.editor.setTheme(newTheme);
});
</script>
</body>
</html>
