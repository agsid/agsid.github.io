<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/x-icon" href="./images/logo.png">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allied Work</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-primary': 'var(--bg-primary)',
                        'bg-secondary': 'var(--bg-secondary)',
                        'bg-tertiary': 'var(--bg-tertiary)',
                        'text-primary': 'var(--text-primary)',
                        'text-secondary': 'var(--text-secondary)',
                        'text-heading-main': 'var(--text-heading-main)',
                        'text-heading-sub': 'var(--text-heading-sub)',
                        'border-color': 'var(--border-color)',
                        'tab-bg-active': 'var(--tab-bg-active)',
                        'tab-bg-inactive': 'var(--tab-bg-inactive)',
                        'tab-border-active': 'var(--tab-border-active)',
                        'tab-border-inactive': 'var(--tab-border-inactive)',
                        'console-bg': 'var(--console-bg)',
                        'console-text': 'var(--console-text)',
                        'status-bar-bg': 'var(--status-bar-bg)',
                        'status-bar-text': 'var(--status-bar-text)',
                        'comment-color': 'var(--comment-color)',
                        'keyword-color': 'var(--keyword-color)',
                        'string-color': 'var(--string-color)',
                        'function-color': 'var(--function-color)',
                        'resizer-bg': 'var(--resizer-bg)',
                        'resizer-hover-bg': 'var(--resizer-hover-bg)',
                        'drive-color': 'var(--drive-color)',
                        'arm-color': 'var(--arm-color)',
                        'turn-color': 'var(--turn-color)',
                        'wait-color': 'var(--wait-color)',
                        'print-color': 'var(--print-color)',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            /* VS Code-like Light Theme */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F3F3F3;
            --bg-tertiary: #E7E7E7;
            --text-primary: #FF5722;
            --text-secondary: #666666;
            --text-heading-main: #007ACC;
            --text-heading-sub: #005A9C;
            --border-color: #CCCCCC;
            --tab-bg-active: #FFFFFF;
            --tab-bg-inactive: #E7E7E7;
            --tab-border-active: #007ACC;
            --tab-border-inactive: transparent;
            --console-bg: #EFEFEF;
            --console-text: #333333;
            --status-bar-bg: #007ACC;
            --status-bar-text: #FFFFFF;
            --comment-color: #4CAF50;
            --keyword-color: #0000FF;
            --string-color: #A31515;
            --function-color: #795E26;
            --resizer-bg: #E0E0E0;
            --resizer-hover-bg: #007ACC;
            --drive-color: #2196F3;
            --arm-color: #9C27B0;
            --turn-color: #F44336;
            --wait-color: #FFC107;
            --print-color: #4CAF50;
        }

        .dark-mode {
            --bg-primary: #1E1E1E;
            --bg-secondary: #252526;
            --bg-tertiary: #333333;
            --text-primary: #D4D4D4; /* Made primary text white for the code editor */
            --text-secondary: #9B9B9B;
            --text-heading-main: #569CD6;
            --text-heading-sub: #4EC9B0;
            --border-color: #3C3C3C;
            --tab-bg-active: #1E1E1E;
            --tab-bg-inactive: #2D2D2D;
            --tab-border-active: #569CD6;
            --tab-border-inactive: transparent;
            --console-bg: #000000;
            --console-text: #D4D4D4;
            --status-bar-bg: #007ACC;
            --status-bar-text: #FFFFFF;
            --comment-color: #4CAF50;
            --keyword-color: #569CD6;
            --string-color: #CE9178;
            --function-color: #DCDCAA;
            --resizer-bg: #4C4C4C;
            --resizer-hover-bg: #569CD6;
            --drive-color: #2196F3;
            --arm-color: #9C27B0;
            --turn-color: #F44336;
            --wait-color: #FFC107;
            --print-color: #4CAF50;
        }

        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            box-sizing: border-box;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        .tab-button {
            border: none;
            background-color: var(--tab-bg-inactive);
            color: var(--text-secondary);
            border-bottom: 2px solid var(--tab-border-inactive);
            transition: all 0.2s ease-in-out;
        }

        .tab-button:hover {
            color: var(--text-primary);
            background-color: var(--tab-bg-active);
        }

        .tab-button.active {
            color: var(--text-primary);
            background-color: var(--tab-bg-active);
            border-bottom: 2px solid var(--tab-border-active);
        }

        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        #line-numbers {
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-family: 'Fira Code', monospace;
            z-index: 3;
        }

        #code-editor {
            font-family: 'Fira Code', monospace;
            background-color: transparent;
            color: transparent;
            caret-color: var(--text-primary);
            resize: none;
            border: none;
            outline: none;
            box-shadow: none;
            z-index: 2;
            overflow: hidden; /* This removes the scrollbar */
        }

        #highlight-overlay {
            font-family: 'Fira Code', monospace;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            z-index: 1;
            pointer-events: none;
        }

        .python-display-container.active, .commands-display-container.active {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            background-color: var(--bg-tertiary);
            overflow: auto;
        }
        
        #commands-content-container {
            overflow-y: auto; /* Add scroll bar for commands */
        }

        #python-code-display, #commands-display-container {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: 'Fira Code', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            height: 100%;
            width: 100%;
            overflow: auto;
        }

        /* New highlighting classes for commands */
        .comment-highlight { color: var(--comment-color); }
        .string-highlight { color: var(--string-color); }
        .function-highlight { color: var(--function-color); }
        .drive-highlight { color: var(--drive-color); }
        .arm-highlight { color: var(--arm-color); }
        .turn-highlight { color: var(--turn-color); }
        .wait-highlight { color: var(--wait-color); }
        .print-highlight { color: var(--print-color); }

        #robot-canvas {
            background-color: transparent; /* Changed to transparent to show background image */
        }

        #console-resizer {
            cursor: ns-resize;
            height: 5px;
            background-color: var(--resizer-bg);
            transition: all 0.2s ease-in-out;
            position: relative;
            z-index: 20;
        }
        
        #console-resizer:hover {
            background-color: var(--resizer-hover-bg);
        }

        #console-resizer-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 20px;
            height: 5px;
            background-color: var(--resizer-bg);
            cursor: ns-resize;
            transition: all 0.2s ease-in-out;
        }

        #console-resizer-handle:hover {
            background-color: var(--resizer-hover-bg);
        }
    </style>
</head>
<body class="dark-mode font-inter antialiased min-h-screen flex justify-center items-center">
    <div id="app-container" class="grid grid-cols-[50px_1fr] grid-rows-[1fr_auto] w-full h-screen bg-bg-primary overflow-hidden">
        <!-- VS Code-like Sidebar -->
        <div id="left-sidebar" class="bg-bg-secondary border-r border-border-color row-span-full flex flex-col items-center justify-start pt-4 text-text-secondary gap-6">
            <img src="./images/logo.png" alt="Allied logo" class="w-10 h-10 mb-4"/>
            <ion-icon name="code-slash-outline" class="text-3xl cursor-pointer transition-colors duration-200 active"></ion-icon>
            <a href="https://agsid.github.io/website/doc.html" target="_blank">
                <ion-icon name="help-circle-outline" class="text-3xl cursor-pointer transition-colors duration-200"></ion-icon>
            </a>
            <a href="https://agsid.github.io/website/index.html" target="_blank">
                <ion-icon name="home-outline" class="text-3xl cursor-pointer transition-colors duration-200"></ion-icon>
            </a>
            <ion-icon name="cog-outline" id="theme-mode-toggle" class="text-3xl cursor-pointer transition-colors duration-200"></ion-icon>
        </div>
        
        <div id="main-content-area" class="grid grid-cols-1 grid-rows-[auto_1fr_auto] h-full">
            <!-- Top Tab Bar -->
            <div id="top-bar" class="flex bg-bg-secondary border-b border-border-color pl-4 items-center">
                <button class="tab-button active py-3 px-6 font-medium cursor-pointer flex items-center" data-tab-target="tab-content-editor">Code Editor</button>
                <button class="tab-button py-3 px-6 font-medium cursor-pointer flex items-center" data-tab-target="tab-content-commands">Available Commands</button>
                <button class="tab-button py-3 px-6 font-medium cursor-pointer flex items-center" data-tab-target="tab-content-python">Generated Python</button>
            </div>

            <!-- Main Content: Editor & Simulation -->
            <div id="editor-and-simulation" class="flex row-start-2 w-full h-full relative">
                <div id="editor-panel" class="tab-content active flex-1 h-full p-4 bg-bg-primary flex flex-col min-w-[250px] border-r border-border-color" data-tab-id="tab-content-editor">
                    <div class="code-editor-container flex-grow relative">
                        <div id="line-numbers" class="absolute top-0 left-0 h-full py-4 px-2 w-10 text-right overflow-y-hidden font-mono text-base leading-snug pointer-events-none box-border"></div>
                        <div id="highlight-overlay" class="absolute top-0 left-0 w-full h-full p-4 pl-[50px] overflow-auto whitespace-pre font-mono text-base leading-snug box-border"></div>
                        <textarea id="code-editor" class="flex-grow p-4 pl-[50px] font-mono text-base leading-snug bg-transparent text-transparent caret-text-primary resize-none border-none outline-none shadow-none box-border relative z-10 overflow-auto whitespace-pre" spellcheck="false" placeholder="Type your commands here...">drive()
turn()
arm()</textarea>
                    </div>
                </div>
                
                <div id="editor-resizer" class="w-[5px] bg-resizer-bg cursor-col-resize transition-colors duration-200 hover:bg-resizer-hover-bg"></div>

                <div id="simulation-panel" class="flex-1 h-full p-4 bg-bg-secondary flex flex-col items-center gap-4 min-w-[250px]">
                    <div class="flex flex-row flex-wrap justify-center space-x-2 mb-6">
                        <button id="minimize-sim-button" class="bg-gray-500 hover:bg-gray-700 text-white py-2.5 px-3 rounded-md font-medium cursor-pointer transition-colors duration-200">
                            <ion-icon name="caret-back-outline"></ion-icon>
                        </button>
                        <button id="run-button" class="bg-[#4CAF50] hover:bg-[#45a049] text-white py-2.5 px-5 rounded-md font-medium cursor-pointer transition-colors duration-200">
                            <svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.132V9.868c0-.836.828-1.309 1.402-.868l3.197 2.132a1 1 0 010 1.736z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Run Code
                        </button>
                        <button id="start-left-button" class="bg-[#2196F3] hover:bg-[#1A7A72] text-white py-2.5 px-5 rounded-md font-medium cursor-pointer transition-colors duration-200">
                            Start on Left
                        </button>
                        <button id="start-right-button" class="bg-[#2196F3] hover:bg-[#1A7A72] text-white py-2.5 px-5 rounded-md font-medium cursor-pointer transition-colors duration-200">
                            Start on Right
                        </button>
                    </div>
                    <canvas id="robot-canvas" class="bg-bg-primary border border-border-color block w-full h-auto max-w-[960px] max-h-[480px] object-contain"></canvas>
                </div>
                
                <div id="tab-content-commands" class="tab-content w-full h-full text-white">
                    <div id="commands-content-container" class="w-full h-full p-4 box-border"></div>
                </div>

                <div id="tab-content-python" class="tab-content python-display-container w-full h-full text-white">
                    <pre id="python-code-display" class="w-full h-full bg-bg-tertiary font-mono text-base leading-snug whitespace-pre-wrap break-all overflow-auto p-4 box-border"></pre>
                </div>
            </div>

            <!-- Bottom Panel: Console Output -->
            <div id="bottom-panel" class="row-start-3 bg-bg-tertiary border-t border-border-color flex flex-col overflow-hidden">
                <div id="console-resizer" class="w-full h-[5px] relative">
                     <div id="console-resizer-handle" class="absolute top-0 right-0 w-[20px] h-[5px] bg-resizer-bg transition-colors duration-200 hover:bg-resizer-hover-bg cursor-ns-resize"></div>
                </div>
                <div id="bottom-panel-tabs" class="flex bg-bg-secondary border-b border-border-color px-4">
                    <button id="console-tab-button" class="active py-2 px-4 bg-none border-none text-text-secondary font-medium cursor-pointer transition-colors duration-200 hover:text-text-primary">Console</button>
                </div>
                <div id="console-output" class="flex-grow overflow-y-auto bg-console-bg text-console-text font-mono text-sm p-2 px-4"></div>
            </div>
        </div>

        <!-- Status Bar -->
        <div id="status-bar" class="col-span-full bg-status-bar-bg text-status-bar-text py-1.5 px-4 text-xs flex justify-end items-center gap-4">
            <span>FLL Bot Programmer</span>
            <span>UTF-8</span>
            <span>LF</span>
            <span>Line 1, Col 1</span>
        </div>
    </div>
    
    <script>
        // HTML content for the Available Commands tab, stored as a JavaScript variable.
        const commandsHtml = `
            <div class="p-6 bg-tertiary-dark rounded-lg">
                <h2 class="text-3xl font-bold mb-4">Allied FLL Bot Programmer</h2>
                <p class="mb-4">Welcome to the Allied FLL Bot Programmer! This web application allows you to program a virtual LEGO Education SPIKE Prime robot to complete missions on a simulated FIRST LEGO League field. Use the available commands below to write your code in the editor, then press "Run Code" to see your robot in action!</p>
                
                <h3 class="text-2xl font-bold mt-8 mb-4">Available Commands</h3>
                <div class="space-y-6">
                    <div class="p-4 border border-gray-600 rounded-lg">
                        <h4 class="text-xl font-semibold">drive(distance)</h4>
                        <p class="mt-2 text-gray-400">Drives the robot straight for a specified distance in inches.</p>
                        <p class="text-sm text-gray-500 mt-1">Example: <code class="bg-gray-700 p-1 rounded">drive(24)</code></p>
                    </div>
                    <div class="p-4 border border-gray-600 rounded-lg">
                        <h4 class="text-xl font-semibold">turn(degrees)</h4>
                        <p class="mt-2 text-gray-400">Turns the robot a specified number of degrees. Positive values turn clockwise, negative values turn counter-clockwise.</p>
                        <p class="text-sm text-gray-500 mt-1">Example: <code class="bg-gray-700 p-1 rounded">turn(90)</code></p>
                    </div>
                    <div class="p-4 border border-gray-600 rounded-lg">
                        <h4 class="text-xl font-semibold">arm(action)</h4>
                        <p class="mt-2 text-gray-400">Moves the robot's arm. Action can be "up", "down", or "reset".</p>
                        <p class="text-sm text-gray-500 mt-1">Example: <code class="bg-gray-700 p-1 rounded">arm("up")</code></p>
                    </div>
                    <div class="p-4 border border-gray-600 rounded-lg">
                        <h4 class="text-xl font-semibold">wait(seconds)</h4>
                        <p class="mt-2 text-gray-400">Pauses the program for a specified number of seconds.</p>
                        <p class="text-sm text-gray-500 mt-1">Example: <code class="bg-gray-700 p-1 rounded">wait(2)</code></p>
                    </div>
                    <div class="p-4 border border-gray-600 rounded-lg">
                        <h4 class="text-xl font-semibold">print("message")</h4>
                        <p class="mt-2 text-gray-400">Displays a message in the console log at the bottom of the screen.</p>
                        <p class="text-sm text-gray-500 mt-1">Example: <code class="bg-gray-700 p-1 rounded">print("Hello, World!")</code></p>
                    </div>
                </div>
            </div>
        `;
        
        const appContainer = document.getElementById('app-container');
        const themeToggle = document.getElementById('theme-mode-toggle');
        const runButton = document.getElementById('run-button');
        const startLeftButton = document.getElementById('start-left-button');
        const startRightButton = document.getElementById('start-right-button');
        const codeEditor = document.getElementById('code-editor');
        const highlightOverlay = document.getElementById('highlight-overlay');
        const pythonCodeDisplay = document.getElementById('python-code-display');
        const commandsContentContainer = document.getElementById('commands-content-container');
        const consoleOutput = document.getElementById('console-output');
        const messageBox = document.getElementById('message-box');
        const uploadButton = document.getElementById('upload-button');
        const fileUpload = document.getElementById('file-upload');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const editorResizer = document.getElementById('editor-resizer');
        const editorPanel = document.getElementById('editor-panel');
        const simulationPanel = document.getElementById('simulation-panel');
        const minimizeSimButton = document.getElementById('minimize-sim-button');
        const consoleResizer = document.getElementById('console-resizer-handle');
        const bottomPanel = document.getElementById('bottom-panel');
        const consoleLog = [];
        const canvas = document.getElementById('robot-canvas');
        const ctx = canvas.getContext('2d');
        const fieldWidth = 960; // FLL field is 96 inches, we scale to 960px
        const fieldHeight = 480; // FLL field is 48 inches, we scale to 480px
        const robotSize = 48;
        
        let robotX = fieldWidth / 2;
        let robotY = fieldHeight - (robotSize / 2);
        let robotAngle = 0; // 0 degrees is facing up
        let simulationRunning = false;
        let simulationQueue = [];
        let messageDisplay = '';
        let commandsLoaded = false;
        
        // FLL Field background image
        const fieldImage = new Image();
        fieldImage.src = './images/field.png'; // Replace with the actual URL of your FLL field image
        fieldImage.onload = () => {
            // The image is loaded, we can now draw the initial canvas state
            drawRobot();
        };

        const commandMapping = {
            'drive': {
                regex: /drive\(([-+]?\d*\.?\d+)\)/,
                python: (distance) => `await drive(${distance})`,
                handler: (distance) => {
                    return new Promise(resolve => {
                        const distanceInPx = distance * 10;
                        const initialX = robotX;
                        const initialY = robotY;
                        const duration = Math.abs(distanceInPx) * 10;
                        const startTime = performance.now();
                        const animate = (time) => {
                            const elapsed = time - startTime;
                            const progress = Math.min(elapsed / duration, 1);
                            const newX = initialX + distanceInPx * Math.sin(robotAngle * Math.PI / 180) * progress;
                            const newY = initialY - distanceInPx * Math.cos(robotAngle * Math.PI / 180) * progress;
                            robotX = newX;
                            robotY = newY;
                            drawRobot();
                            if (progress < 1) {
                                requestAnimationFrame(animate);
                            } else {
                                resolve();
                            }
                        };
                        requestAnimationFrame(animate);
                    });
                }
            },
            'turn': {
                regex: /turn\(([-+]?\d*\.?\d+)\)/,
                python: (degrees) => `await turn(${degrees})`,
                handler: (degrees) => {
                    return new Promise(resolve => {
                        const initialAngle = robotAngle;
                        const duration = Math.abs(degrees) * 10;
                        const startTime = performance.now();
                        const animate = (time) => {
                            const elapsed = time - startTime;
                            const progress = Math.min(elapsed / duration, 1);
                            robotAngle = initialAngle + degrees * progress;
                            drawRobot();
                            if (progress < 1) {
                                requestAnimationFrame(animate);
                            } else {
                                resolve();
                            }
                        };
                        requestAnimationFrame(animate);
                    });
                }
            },
            'print': {
                regex: /print\(\"(.+?)\"\)/,
                python: (message) => `print("${message}")`,
                handler: (message) => {
                    return new Promise(resolve => {
                        logToConsole(message, 'info');
                        resolve();
                    });
                }
            },
            'wait': {
                regex: /wait\(([-+]?\d*\.?\d+)\)/,
                python: (seconds) => `wait(${parseFloat(seconds) * 1000})`,
                handler: (seconds) => {
                    return new Promise(resolve => {
                        const milliseconds = parseFloat(seconds) * 1000;
                        logToConsole(`Waiting for ${seconds}s...`, 'info');
                        setTimeout(resolve, milliseconds);
                    });
                }
            },
            'arm': {
                regex: /arm\(\"(.+?)\"\)/,
                python: (action) => {
                    if (action === "up") {
                        return `speed_motor(50) # Assuming a speed of 50 for the arm motor
    await turn_motor(port.A, 90) # Assuming 'up' is a 90-degree turn on port A`;
                    } else if (action === "down") {
                        return `speed_motor(50)
    await turn_motor(port.A, -90) # Assuming 'down' is a -90-degree turn on port A`;
                    } else if (action === "reset") {
                        return `speed_motor(50)
    await turn_motor(port.A, 0) # Assuming 'reset' is a 0-degree turn on port A`;
                    }
                    return `# WARNING: Invalid arm action: ${action}`;
                },
                handler: (action) => {
                    return new Promise(resolve => {
                        logToConsole(`Arm action: ${action}`, 'info');
                        setTimeout(resolve, 500); // Simulate arm movement time
                    });
                }
            }
        };
        function setupCanvas() {
            canvas.width = fieldWidth;
            canvas.height = fieldHeight;
            drawRobot();
        }
        function drawRobot() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw the FLL field background image first
            if (fieldImage.complete && fieldImage.naturalHeight !== 0) {
                ctx.drawImage(fieldImage, 0, 0, canvas.width, canvas.height);
            } else {
                // Fallback if the image hasn't loaded
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary');
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border-color');
                ctx.lineWidth = 2;
                ctx.strokeRect(0, 0, canvas.width, canvas.height);
                // Draw a simple FLL home base area
                ctx.fillStyle = 'rgba(128, 128, 128, 0.2)';
                ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
            }

            // Save the context state before rotating
            ctx.save();
            // Translate to the robot's position and rotate the context
            ctx.translate(robotX, robotY);
            ctx.rotate(robotAngle * Math.PI / 180);
            // Draw the robot
            ctx.fillStyle = '#1A7A72'; // Dark teal
            ctx.fillRect(-robotSize / 2, -robotSize / 2, robotSize, robotSize);
            // Draw the direction indicator (a triangle)
            ctx.fillStyle = '#0F2D37'; // Even darker color
            ctx.beginPath();
            ctx.moveTo(0, -robotSize / 2);
            ctx.lineTo(-robotSize / 3, 0);
            ctx.lineTo(robotSize / 3, 0);
            ctx.closePath();
            ctx.fill();
            // Restore the context state to prevent further drawing from being rotated
            ctx.restore();
            // Draw message display
            if (messageDisplay) {
                ctx.fillStyle = '#ffffff';
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 1;
                ctx.font = '24px "Montserrat", sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const textWidth = ctx.measureText(messageDisplay).width;
                const boxWidth = textWidth + 30;
                const boxHeight = 50;
                const boxX = (canvas.width - boxWidth) / 2;
                const boxY = (canvas.height - boxHeight) / 2;
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(boxX, boxY, boxWidth, boxHeight);
                ctx.fillStyle = '#ffffff';
                ctx.fillText(messageDisplay, canvas.width / 2, canvas.height / 2);
            }
        }
        function logToConsole(message, type) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            consoleLog.push(logEntry);
            updateConsoleOutput();
        }
        function updateConsoleOutput() {
            consoleOutput.innerHTML = '';
            consoleLog.forEach(logEntry => {
                const line = document.createElement('div');
                line.classList.add('console-line');
                const timestampSpan = document.createElement('span');
                timestampSpan.classList.add('console-timestamp');
                timestampSpan.textContent = `[${logEntry.timestamp}]`;
                line.appendChild(timestampSpan);
                line.appendChild(document.createTextNode(logEntry.message));
                consoleOutput.appendChild(line);
            });
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        function showMessage(message, isError = false) {
            // This function is now effectively disabled by CSS, but keeping it for potential future use
        }
        function updateSyntaxHighlighting() {
            const text = codeEditor.value;
            let highlightedText = escapeHtml(text);
            const lineNumbers = document.getElementById('line-numbers');
            if (lineNumbers) {
                const lines = text.split('\n').length;
                lineNumbers.innerHTML = Array.from({ length: lines }, (_, i) => `<div>${i + 1}</div>`).join('');
            }
            
            // Highlight specific commands with their new colors
            highlightedText = highlightedText.replace(/\b(drive)\b/g, '<span class="drive-highlight">drive</span>');
            highlightedText = highlightedText.replace(/\b(arm)\b/g, '<span class="arm-highlight">arm</span>');
            highlightedText = highlightedText.replace(/\b(turn)\b/g, '<span class="turn-highlight">turn</span>');
            highlightedText = highlightedText.replace(/\b(wait)\b/g, '<span class="wait-highlight">wait</span>');
            highlightedText = highlightedText.replace(/\b(print)\b/g, '<span class="print-highlight">print</span>');
            
            // Highlighting for comments and strings
            highlightedText = highlightedText.replace(/(\/\/.*)/g, '<span class="comment-highlight">$1</span>');
            highlightedText = highlightedText.replace(/(\".*?\")/g, '<span class="string-highlight">$1</span>');

            highlightOverlay.innerHTML = highlightedText;
        }
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        function startSimulation() {
            if (simulationRunning) {
                return;
            }
            const commands = codeEditor.value.trim().split('\n').filter(line => line.trim() !== '' && !line.trim().startsWith('//'));
            
            // Validate all commands before starting
            for (const commandLine of commands) {
                let matched = false;
                for (const command of Object.values(commandMapping)) {
                    if (commandLine.match(command.regex)) {
                        matched = true;
                        break;
                    }
                }
                if (!matched) {
                    logToConsole(`ERROR: Unknown command or syntax error on line: "${commandLine}". Simulation aborted.`, 'error');
                    return; // Abort the entire simulation
                }
            }
            
            simulationRunning = true;
            simulationQueue = [...commands];
            logToConsole('Simulation started.', 'info');
            runNextCommand();
        }
        async function runNextCommand() {
            if (simulationQueue.length === 0 || !simulationRunning) {
                simulationRunning = false;
                logToConsole('Simulation finished.', 'info');
                return;
            }
            const commandLine = simulationQueue.shift().trim();
            logToConsole(`> Running command: ${commandLine}`, 'info');
            let matched = false;
            for (const command of Object.values(commandMapping)) {
                const match = commandLine.match(command.regex);
                if (match) {
                    matched = true;
                    try {
                        await command.handler(...match.slice(1));
                    } catch (e) {
                        logToConsole(`Error executing command: ${commandLine}`, 'error');
                        console.error(e);
                    }
                    break;
                }
            }
            if (!matched) {
                logToConsole(`Unknown command: ${commandLine}`, 'error');
            }
            runNextCommand();
        }
        function generatePythonCode() {
            const lines = codeEditor.value.trim().split('\n');
            let generatedCode = `import runloop,math,motor_pair,motor,time
from hub import port
# r is the radius of the wheel. This is used to find the circumference of the wheel
r = 22 # Assuming a standard LEGO wheel with a radius of 22mm
# This is the angle changed when the wheels run for 1 rotation in opposite directions.
# This is used in the turning function to convert a desired turn angle into motor degrees.
total=100

def speed(x):
    global velocity
    velocity = x*110

async def drive(desired):
    circumference=2*r*math.pi
    rotations=desired/circumference
    degrees=int(rotations*360)
    await motor_pair.move_for_degrees(motor_pair.PAIR_1, degrees, 0, velocity=velocity)

async def turn(desired):
    distance=int((desired/total)*360)
    await motor_pair.move_for_degrees(motor_pair.PAIR_1, distance, 100)

def speed_motor(x):
    global velocity_motor
    velocity_motor = x*110

async def turn_motor(port,desired):
    angle = desired/2
    motor.run_for_degrees(port.port, angle, velocity_motor)

def wait(mili):
    time.sleep_ms(mili)

async def main():
    motor_pair.pair(motor_pair.PAIR_1, port.C, port.D)
    
    # User's code starts here
    # We will set a default drive speed.
    speed(50)
    
`;
            
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('//') || trimmedLine === '') {
                    generatedCode += `\n    ${trimmedLine}`;
                    return;
                }
                let translated = false;
                for (const command of Object.values(commandMapping)) {
                    const match = trimmedLine.match(command.regex);
                    if (match) {
                        const pythonCode = command.python(...match.slice(1));
                        generatedCode += `\n    ${pythonCode.split('\n').join('\n    ')}`;
                        translated = true;
                        break;
                    }
                }
                if (!translated) {
                    generatedCode += `\n    # WARNING: Could not translate this line: ${trimmedLine}`;
                }
            });

            generatedCode += `\n    \nrunloop.run(main())`;
            
            pythonCodeDisplay.innerText = generatedCode;
        }

        // --- Local Storage Functions ---
        const LOCAL_STORAGE_KEY = 'fll_bot_code';

        function saveCodeToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_KEY, codeEditor.value);
            logToConsole('Code saved to local storage.', 'info');
        }

        function loadCodeFromLocalStorage() {
            const savedCode = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedCode) {
                codeEditor.value = savedCode;
                updateSyntaxHighlighting();
                logToConsole('Code loaded from local storage.', 'info');
            } else {
                logToConsole('No saved code found in local storage.', 'info');
            }
        }
        
        function clearCodeFromLocalStorage() {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            codeEditor.value = `drive()
turn()
arm()`;
            updateSyntaxHighlighting();
            logToConsole('Local storage cleared.', 'info');
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
        // Event Listeners
        runButton.addEventListener('click', () => {
            generatePythonCode();
            startSimulation();
        });

        startLeftButton.addEventListener('click', () => {
            simulationRunning = false;
            simulationQueue = [];
            robotX = robotSize * 2;
            robotY = fieldHeight - (robotSize / 2);
            robotAngle = 0;
            consoleLog.length = 0;
            updateConsoleOutput();
            drawRobot();
            logToConsole('Robot moved to the left starting position.', 'info');
        });

        startRightButton.addEventListener('click', () => {
            simulationRunning = false;
            simulationQueue = [];
            robotX = fieldWidth - (robotSize * 2);
            robotY = fieldHeight - (robotSize / 2);
            robotAngle = 0;
            consoleLog.length = 0;
            updateConsoleOutput();
            drawRobot();
            logToConsole('Robot moved to the right starting position.', 'info');
        });


        // Auto-save on input with debounce
        codeEditor.addEventListener('input', () => {
            updateSyntaxHighlighting();
            debounce(saveCodeToLocalStorage, 500)();
        });
        
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
        });

        // Resizer Logic
        editorResizer.addEventListener('mousedown', (e) => {
            let initialX = e.clientX;
            let initialEditorWidth = editorPanel.offsetWidth;

            const onMouseMove = (moveEvent) => {
                const dx = moveEvent.clientX - initialX;
                let newWidth = initialEditorWidth + dx;
                
                // Clamp the new width to prevent panels from becoming too small
                if (newWidth < 250) { newWidth = 250; }
                if (newWidth > editorPanel.parentElement.offsetWidth - 250) {
                    newWidth = editorPanel.parentElement.offsetWidth - 250;
                }
                
                editorPanel.style.flex = `0 0 ${newWidth}px`;
                simulationPanel.style.flex = `1`; // Let simulation panel grow/shrink
            };

            const onMouseUp = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });

        // Minimize Simulation Panel Logic
        let isSimMinimized = false;
        minimizeSimButton.addEventListener('click', () => {
            isSimMinimized = !isSimMinimized;
            if (isSimMinimized) {
                simulationPanel.style.flexBasis = '0';
                simulationPanel.style.minWidth = '0';
                simulationPanel.style.padding = '0';
                simulationPanel.style.overflow = 'hidden';
                simulationPanel.style.borderLeft = '0';
                minimizeSimButton.innerHTML = '<ion-icon name="caret-forward-outline"></ion-icon>';
            } else {
                simulationPanel.style.flexBasis = '1';
                simulationPanel.style.minWidth = '250px';
                simulationPanel.style.padding = '1rem';
                simulationPanel.style.overflow = 'auto';
                simulationPanel.style.borderLeft = '1px solid var(--border-color)';
                minimizeSimButton.innerHTML = '<ion-icon name="caret-back-outline"></ion-icon>';
            }
        });

        // Console Resizer Logic
        consoleResizer.addEventListener('mousedown', (e) => {
            const initialY = e.clientY;
            const initialHeight = bottomPanel.offsetHeight;
            const maxConsoleHeight = window.innerHeight * 0.5;
            const minConsoleHeight = 150;

            const onMouseMove = (moveEvent) => {
                const dy = moveEvent.clientY - initialY;
                let newHeight = initialHeight - dy;
                
                if (newHeight < minConsoleHeight) {
                    newHeight = minConsoleHeight;
                }
                if (newHeight > maxConsoleHeight) {
                    newHeight = maxConsoleHeight;
                }
                
                bottomPanel.style.height = `${newHeight}px`;
                bottomPanel.style.minHeight = `${minConsoleHeight}px`;
                bottomPanel.style.maxHeight = `${maxConsoleHeight}px`;
            };

            const onMouseUp = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
        
        // Tab switching logic
        tabButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const targetId = button.dataset.tabTarget;
                const targetContent = document.getElementById(targetId);

                tabButtons.forEach(btn => {
                    btn.classList.remove('active');
                });
                tabContents.forEach(content => content.classList.remove('active'));
                
                button.classList.add('active');
                targetContent.classList.add('active');

                if (targetId === 'tab-content-python') {
                    generatePythonCode();
                }

                if (targetId === 'tab-content-commands' && !commandsLoaded) {
                    commandsContentContainer.innerHTML = commandsHtml;
                    commandsLoaded = true;
                }
            });
        });

        // Initial setup
        window.onload = function() {
            setupCanvas();
            loadCodeFromLocalStorage();
            updateSyntaxHighlighting();
            document.getElementById('editor-panel').classList.add('active');
            // Pre-load the commands HTML on initial load
            commandsContentContainer.innerHTML = commandsHtml;
            commandsLoaded = true;
        };
    </script>
</body>
</html>
