<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AlliedWork â€“ Team</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-[#050505] text-white font-sans p-6 md:p-12">

  <div id="app" class="max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-12">
        <h1 class="text-xl font-bold italic tracking-tighter">ALLIED WORK</h1>
        <button onclick="logout()" class="text-xs text-zinc-500 hover:text-white transition uppercase tracking-widest font-bold px-4 py-2 bg-white/5 rounded-full border border-white/5">Sign Out</button>
    </div>

    <div id="loading" class="text-center py-20">
        <div class="inline-block w-8 h-8 border-2 border-white/20 border-t-white rounded-full animate-spin mb-4"></div>
        <p class="text-zinc-500 text-sm animate-pulse">Syncing workspace...</p>
    </div>

    <div id="noTeamView" class="hidden text-center py-10">
      <h2 class="text-4xl font-bold mb-3 tracking-tight">Your Workspace</h2>
      <p class="text-zinc-400 mb-10">You aren't associated with a team yet.</p>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-xl mx-auto">
        <button onclick="createTeam()" class="p-10 bg-white text-black rounded-[2rem] font-bold transition-all hover:scale-[1.02] active:scale-95 shadow-xl text-lg">
            Create Team
        </button>
        <button onclick="joinTeam()" class="p-10 bg-zinc-900 border border-white/10 rounded-[2rem] font-bold hover:bg-zinc-800 transition-all hover:scale-[1.02] active:scale-95 text-lg">
            Join Team
        </button>
      </div>
    </div>

    <div id="teamView" class="hidden">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-12">
        <div>
          <div class="flex items-center gap-4">
            <h2 id="teamName" class="text-5xl font-black italic uppercase tracking-tighter leading-none">TEAM NAME</h2>
            <button onclick="copyInviteID()" class="text-[10px] bg-white/10 px-2 py-1 rounded hover:bg-white/20 transition text-zinc-400 uppercase font-bold">Copy Invite ID</button>
          </div>
          <div class="flex items-center gap-2 mt-2">
            <span class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></span>
            <p id="userStatus" class="text-zinc-500 text-[10px] font-bold uppercase tracking-[0.2em]"></p>
          </div>
        </div>
        <button onclick="createFile()" class="w-full md:w-auto px-8 py-4 bg-indigo-600 rounded-2xl text-sm font-bold hover:bg-indigo-500 transition shadow-xl active:scale-95">+ Create File</button>
      </div>

      <div id="fileList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient("https://juqwqfppqfuspcesueoz.supabase.co", "sb_publishable_WGy2N08B0i34_K84gtVDxw_5v4jm5NB");

    let currentUserId = null;
    let currentTeamId = null;

    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return window.location.replace("login.html");

      currentUserId = session.user.id;
      document.getElementById('userStatus').textContent = session.user.email;

      try {
        const { data: membership, error: memError } = await supabase
          .from('team_members')
          .select('team_id, teams(name)')
          .eq('user_id', currentUserId)
          .maybeSingle();

        document.getElementById('loading').classList.add('hidden');

        if (!membership) {
          document.getElementById('noTeamView').classList.remove('hidden');
        } else {
          currentTeamId = membership.team_id;
          renderTeam(membership.teams.name);
        }
      } catch (err) {
        console.error(err);
      }
    }

    async function renderTeam(name) {
      document.getElementById('teamName').textContent = name;
      document.getElementById('teamView').classList.remove('hidden');

      const { data: files } = await supabase
        .from('code_files')
        .select('*')
        .eq('team_id', currentTeamId)
        .order('updated_at', { ascending: false });

      const list = document.getElementById('fileList');
      if (files?.length > 0) {
        list.innerHTML = files.map(f => `
          <div class="p-6 bg-zinc-900/40 border border-white/5 rounded-[2rem] hover:border-indigo-500/50 transition cursor-pointer">
            <h3 class="font-bold text-white mb-1 truncate text-lg">${f.filename}</h3>
            <p class="text-[9px] text-zinc-600 uppercase font-black tracking-widest">Last Sync: ${new Date(f.updated_at).toLocaleDateString()}</p>
          </div>
        `).join('');
      } else {
        list.innerHTML = `<div class="col-span-full py-20 text-center border-2 border-dashed border-white/5 rounded-[2rem] text-zinc-600 italic">Workspace is empty.</div>`;
      }
    }

    // --- Actions ---

    window.createTeam = async () => {
      const name = prompt("Enter a name for your Team:");
      if (!name) return;

      try {
        const { data: team, error: tErr } = await supabase.from('teams').insert([{ name }]).select().single();
        if (tErr) throw tErr;

        await supabase.from('team_members').insert([{ team_id: team.id, user_id: currentUserId }]);
        location.reload();
      } catch (err) { alert(err.message); }
    };

    window.joinTeam = async () => {
      const inviteId = prompt("Paste the Team Invite ID here:");
      if (!inviteId) return;

      try {
        // Just try to insert the membership. If the ID is wrong, foreign key fails.
        const { error } = await supabase.from('team_members').insert([{ 
            team_id: inviteId, 
            user_id: currentUserId 
        }]);

        if (error) throw new Error("Invalid ID or you are already in this team.");
        
        location.reload();
      } catch (err) {
        alert(err.message);
      }
    };

    window.createFile = async () => {
      const filename = prompt("File name (e.g. main.py):");
      if (!filename) return;

      try {
        const { error } = await supabase.from('code_files').insert([{ filename, team_id: currentTeamId }]);
        if (error) throw error;
        location.reload();
      } catch (err) { alert(err.message); }
    };

    window.copyInviteID = () => {
        navigator.clipboard.writeText(currentTeamId);
        alert("Invite ID copied! Send this to your teammates.");
    };

    window.logout = async () => {
      await supabase.auth.signOut();
      window.location.replace("login.html");
    };

    init();
  </script>
</body>
</html>