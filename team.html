<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AlliedWork â€“ Team</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-[#050505] text-white font-sans p-6 md:p-12">

  <div id="app" class="max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-12">
        <h1 class="text-xl font-bold italic tracking-tighter">ALLIED WORK</h1>
        <button onclick="logout()" class="text-xs text-zinc-500 hover:text-white transition uppercase tracking-widest font-bold">Sign Out</button>
    </div>

    <div id="loading" class="text-center py-20">
        <div class="inline-block w-8 h-8 border-2 border-white/20 border-t-white rounded-full animate-spin mb-4"></div>
        <p class="text-zinc-500 text-sm animate-pulse">Syncing workspace...</p>
    </div>

    <div id="noTeamView" class="hidden text-center py-10">
      <h2 class="text-4xl font-bold mb-3 tracking-tight">Your Workspace</h2>
      <p class="text-zinc-400 mb-8">You aren't associated with a team yet.</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-lg mx-auto">
        <button onclick="createTeam()" class="p-8 bg-white text-black rounded-3xl font-bold hover:bg-zinc-200 transition-all active:scale-95 shadow-xl">
            Create Team
        </button>
        <button onclick="alert('Invite system coming soon!')" class="p-8 bg-zinc-900 border border-white/10 rounded-3xl font-bold hover:bg-zinc-800 transition-all active:scale-95">
            Join Team
        </button>
      </div>
    </div>

    <div id="teamView" class="hidden">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-10">
        <div>
          <h2 id="teamName" class="text-4xl font-bold italic uppercase tracking-tighter">TEAM NAME</h2>
          <p id="userStatus" class="text-zinc-500 text-xs font-medium uppercase tracking-widest mt-1"></p>
        </div>
        <button onclick="createFile()" class="px-6 py-3 bg-indigo-600 rounded-2xl text-sm font-bold hover:bg-indigo-500 transition shadow-lg shadow-indigo-500/20 active:scale-95">+ Create File</button>
      </div>
      <div id="fileList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
  </div>

  <div id="debugLog" class="fixed bottom-4 right-4 text-[10px] font-mono text-zinc-600 max-w-xs pointer-events-none"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient("https://juqwqfppqfuspcesueoz.supabase.co", "sb_publishable_WGy2N08B0i34_K84gtVDxw_5v4jm5NB");

    let currentUserId = null;
    let currentTeamId = null;

    // Helper to log errors to screen
    const log = (msg) => {
        console.log(msg);
        document.getElementById('debugLog').innerText += `\n> ${msg}`;
    };

    async function init() {
      log("Initializing...");
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      
      if (!session || sessionError) {
        log("No session found. Redirecting...");
        return window.location.replace("login.html");
      }

      currentUserId = session.user.id;
      document.getElementById('userStatus').textContent = session.user.email;
      log("User: " + session.user.email);

      try {
        const { data: membership, error: memError } = await supabase
          .from('team_members')
          .select('team_id, teams(name)')
          .eq('user_id', currentUserId)
          .maybeSingle();

        if (memError) throw memError;

        document.getElementById('loading').classList.add('hidden');

        if (!membership) {
          log("No membership found.");
          document.getElementById('noTeamView').classList.remove('hidden');
        } else {
          log("Team found: " + membership.teams.name);
          currentTeamId = membership.team_id;
          renderTeam(membership.teams.name);
        }
      } catch (err) {
        log("Error: " + err.message);
        document.getElementById('loading').innerHTML = `<p class="text-red-500">Database Error: ${err.message}</p>`;
      }
    }

    async function renderTeam(name) {
      document.getElementById('teamName').textContent = name;
      document.getElementById('teamView').classList.remove('hidden');

      const { data: files, error } = await supabase
        .from('code_files')
        .select('*')
        .eq('team_id', currentTeamId);

      const list = document.getElementById('fileList');
      if (files && files.length > 0) {
        list.innerHTML = files.map(f => `
          <div class="p-6 bg-zinc-900/40 border border-white/5 rounded-3xl hover:border-indigo-500/50 transition cursor-pointer group">
            <h3 class="font-bold text-white mb-1 truncate">${f.filename}</h3>
            <p class="text-[10px] text-zinc-600 uppercase font-bold tracking-widest">Modified ${new Date(f.updated_at).toLocaleDateString()}</p>
          </div>
        `).join('');
      } else {
        list.innerHTML = `<div class="col-span-full py-12 text-center text-zinc-500 text-sm border border-dashed border-white/5 rounded-3xl">No files found.</div>`;
      }
    }

    // --- Global Window Actions ---
    
    window.createTeam = async () => {
      log("createTeam triggered");
      const name = prompt("Enter Team Name:");
      if (!name) return;

      try {
        // 1. Insert Team
        const { data: team, error: tErr } = await supabase
          .from('teams')
          .insert([{ name }])
          .select()
          .single();

        if (tErr) throw tErr;

        // 2. Insert Membership
        const { error: mErr } = await supabase
          .from('team_members')
          .insert([{ 
            team_id: team.id, 
            user_id: currentUserId, 
            role: 'owner' 
          }]);

        if (mErr) throw mErr;

        log("Team created successfully!");
        location.reload();
      } catch (err) {
        log("Create Team Failed: " + err.message);
        alert(err.message);
      }
    };

    window.createFile = async () => {
      const filename = prompt("File Name (e.g., script.js):");
      if (!filename) return;

      try {
        const { error } = await supabase
          .from('code_files')
          .insert([{ 
            filename, 
            team_id: currentTeamId,
            last_edited_by: currentUserId 
          }]);

        if (error) throw error;
        location.reload();
      } catch (err) {
        log("File Creation Failed: " + err.message);
        alert(err.message);
      }
    };

    window.logout = async () => {
      await supabase.auth.signOut();
      window.location.replace("login.html");
    };

    // Initialize the app
    init();
  </script>
</body>
</html>