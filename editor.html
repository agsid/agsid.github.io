<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AlliedWork – Monaco Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background-color: #050505; font-family: 'JetBrains Mono', monospace; }
        /* Monaco needs an explicit height or a flex-grow container */
        #monaco-editor-container { height: 100%; width: 100%; }
        .monaco-editor, .overflow-guard { border-radius: 0px !important; }
    </style>
</head>
<body class="text-white h-screen flex flex-col overflow-hidden">

    <header class="flex items-center justify-between px-6 py-4 border-b border-white/10 bg-[#050505] z-10">
        <div class="flex items-center gap-6">
            <a href="team.html" class="text-zinc-600 hover:text-white transition text-[10px] font-black uppercase tracking-widest">← Back</a>
            <div>
                <h1 id="fileName" class="text-sm font-bold text-zinc-200">loading...</h1>
                <div class="flex items-center gap-2">
                    <div id="statusDot" class="w-1.5 h-1.5 rounded-full bg-zinc-800"></div>
                    <span id="saveStatus" class="text-[9px] uppercase font-bold text-zinc-600 tracking-tighter">Initializing</span>
                </div>
            </div>
        </div>
        <button onclick="runCode()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] font-black uppercase tracking-widest rounded-full transition shadow-lg shadow-indigo-600/20 active:scale-95">
            Run Code
        </button>
    </header>

    <main class="flex-1 flex flex-col min-h-0 bg-[#050505]">
        <div class="px-14 pt-6 pb-2 opacity-30 pointer-events-none text-[12px] text-indigo-400 select-none">
            import hub from spike<br>
            def runloop():<br>
            <span class="ml-4">while True:</span>
        </div>

        <div class="flex-1 relative">
            <div id="monaco-editor-container" class="absolute inset-0"></div>
        </div>

        <div class="px-14 pt-2 pb-6 opacity-30 pointer-events-none text-[12px] text-indigo-400 select-none">
            <span class="ml-4"># end loop</span><br>
            runloop()
        </div>
    </main>

    <div id="console" class="h-56 bg-black border-t border-white/10 flex flex-col">
        <div class="px-4 py-2 border-b border-white/5 bg-[#0a0a0a] flex justify-between items-center">
            <span class="text-[9px] font-black text-zinc-500 uppercase tracking-widest">SPIKE Prime Terminal</span>
            <button onclick="document.getElementById('consoleLog').innerHTML = ''" class="text-[9px] text-zinc-700 hover:text-zinc-300 transition uppercase font-bold">Clear</button>
        </div>
        <div id="consoleLog" class="flex-1 p-4 overflow-y-auto text-[11px] font-mono text-zinc-400 space-y-1">
            <div class="opacity-30 italic">Terminal link established. Waiting for sequence...</div>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
        import { VALID_COMMANDS, isValid, getFullCode } from './commands.js';

        const supabase = createClient("https://juqwqfppqfuspcesueoz.supabase.co", "sb_publishable_WGy2N08B0i34_K84gtVDxw_5v4jm5NB");
        const urlParams = new URLSearchParams(window.location.search);
        const fileId = urlParams.get('id');
        
        const consoleLog = document.getElementById('consoleLog');
        const saveStatus = document.getElementById('saveStatus');
        const statusDot = document.getElementById('statusDot');
        
        let editor;

        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            
            // 1. Define custom language highlighting
            monaco.languages.register({ id: 'spike' });
            monaco.languages.setMonarchTokensProvider('spike', {
                tokenizer: {
                    root: [
                        [new RegExp(`\\b(${VALID_COMMANDS.join('|')})\\b`), 'custom-keyword'],
                        [/\d+/, 'custom-number'],
                        [/#.*$/, 'custom-comment'],
                    ]
                }
            });

            // 2. Custom Theme
            monaco.editor.defineTheme('spikeDark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'custom-keyword', foreground: '818cf8', fontStyle: 'bold' },
                    { token: 'custom-number', foreground: 'c084fc' },
                    { token: 'custom-comment', foreground: '3f3f46', fontStyle: 'italic' },
                ],
                colors: {
                    'editor.background': '#050505',
                    'editor.lineHighlightBackground': '#111111',
                    'editorCursor.foreground': '#818cf8',
                    'editor.selectionBackground': '#222222',
                    'editorLineNumber.foreground': '#333333',
                    'editorLineNumber.activeForeground': '#666666',
                }
            });

            // 3. Create Editor
            editor = monaco.editor.create(document.getElementById('monaco-editor-container'), {
                value: '',
                language: 'spike',
                theme: 'spikeDark',
                automaticLayout: true,
                fontFamily: 'JetBrains Mono',
                fontSize: 13,
                minimap: { enabled: false },
                lineNumbers: 'on',
                scrollBeyondLastLine: false,
                padding: { top: 10 },
                renderLineHighlight: 'none',
                scrollbar: { verticalScrollbarSize: 8, horizontalScrollbarSize: 8 }
            });

            // 4. Validation Squigglies
            editor.onDidChangeModelContent(() => {
                const model = editor.getModel();
                const code = model.getValue();
                const markers = [];
                
                const lines = code.split('\n');
                lines.forEach((line, i) => {
                    const words = line.match(/\b(\w+)\b/g) || [];
                    words.forEach(word => {
                        if (!isValid(word)) {
                            const startCol = line.indexOf(word) + 1;
                            markers.push({
                                message: `Unknown command: ${word}`,
                                severity: monaco.MarkerSeverity.Error,
                                startLineNumber: i + 1,
                                startColumn: startCol,
                                endLineNumber: i + 1,
                                endColumn: startCol + word.length
                            });
                        }
                    });
                });
                monaco.editor.setModelMarkers(model, 'spike', markers);

                // Auto-save logic
                statusDot.className = "w-1.5 h-1.5 rounded-full bg-indigo-500 animate-pulse";
                saveStatus.innerText = "Syncing...";
                clearTimeout(window.saveTimer);
                window.saveTimer = setTimeout(() => saveToSupabase(code), 1500);
            });

            loadFileData();
        });

        async function saveToSupabase(code) {
            const { error } = await supabase.from('code_files').update({ content: code }).eq('id', fileId);
            if (!error) {
                saveStatus.innerText = "Synced";
                statusDot.className = "w-1.5 h-1.5 rounded-full bg-emerald-500";
            }
        }

        async function loadFileData() {
            const { data } = await supabase.from('code_files').select('*').eq('id', fileId).single();
            if (data) {
                document.getElementById('fileName').innerText = data.filename;
                editor.setValue(data.content || "");
                saveStatus.innerText = "Ready";
            }
        }

        window.runCode = () => {
            const userCode = editor.getValue();
            const finalSource = getFullCode(userCode);
            
            const div = document.createElement('div');
            div.className = "py-2 border-l-2 border-indigo-500 pl-4 bg-indigo-500/5 mb-2";
            div.innerHTML = `
                <div class="text-indigo-400 font-bold uppercase text-[9px] mb-1">Payload Built Successfully</div>
                <pre class="text-zinc-500 text-[10px] overflow-x-auto">${finalSource}</pre>
            `;
            consoleLog.prepend(div);
            consoleLog.prepend(Object.assign(document.createElement('div'), { 
                className: "text-emerald-500 font-bold", 
                innerText: "> Sequence Uploaded to SPIKE Hub" 
            }));
        };
    </script>
</body>
</html>