<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pybricks BLE Control</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6 flex flex-col items-center gap-6">

<button id="connectBtn" class="bg-indigo-600 px-4 py-2 rounded-lg">Connect to Pybricks Hub</button>

<textarea id="log" class="w-full max-w-md h-40 bg-black text-green-400 p-2 rounded"></textarea>

<input id="cmdInput" class="w-full max-w-md p-2 rounded bg-gray-800 text-white" placeholder="Type command to send">
<button id="sendBtn" class="bg-green-600 px-4 py-2 rounded-lg">Send Command</button>

<script>
const PYBRICKS_SERVICE     = '0000fd02-0000-1000-8000-00805f9b34fb';
const PYBRICKS_RX_UUID     = '0000fd02-0001-1000-8000-00805f9b34fb';
const PYBRICKS_TX_UUID     = '0000fd02-0002-1000-8000-00805f9b34fb';

let bleDevice, bleServer;
let rxChar, txChar;

function log(msg) {
  const area = document.getElementById('log');
  area.value += msg + "\n";
  area.scrollTop = area.scrollHeight;
}

async function connectToHub() {
  try {
    log("Requesting Pybricks device...");
    bleDevice = await navigator.bluetooth.requestDevice({
      filters: [{ services: [PYBRICKS_SERVICE] }]
    });

    log("Connecting...");
    bleServer = await bleDevice.gatt.connect();

    log("Getting Pybricks service...");
    const service = await bleServer.getPrimaryService(PYBRICKS_SERVICE);

    log("Getting RX/TX characteristics...");
    rxChar = await service.getCharacteristic(PYBRICKS_RX_UUID);
    txChar = await service.getCharacteristic(PYBRICKS_TX_UUID);

    log("Subscribing to hub notifications...");
    await txChar.startNotifications();
    txChar.addEventListener('characteristicvaluechanged', evt => {
      const text = new TextDecoder().decode(evt.target.value);
      log("RX < Hub: " + text);
    });

    log("Connected and ready!");
  } catch (err) {
    log("Connection failed: " + err);
    console.error(err);
  }
}

async function sendCommand() {
  const input = document.getElementById('cmdInput').value;
  if (!rxChar) {
    log("Not connected or RX characteristic missing");
    return;
  }
  const data = new TextEncoder().encode(input);
  await rxChar.writeValueWithoutResponse(data);
  log("TX > You: " + input);
}

document.getElementById('connectBtn').onclick = connectToHub;
document.getElementById('sendBtn').onclick = sendCommand;
</script>

</body>
</html>
